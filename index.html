<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche √©l√®ve ‚Äì R√©seaux informatiques</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a35;
      --ink:#e9eefc;
      --muted:#a9b3d6;
      --accent:#4dd0e1;
      --accent-2:#7c4dff;
      --ok:#22c55e;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background: var(--bg);
      line-height:1.5;
      background-image: radial-gradient(ellipse at 10% -10%, rgba(124,77,255,.15), transparent 50%), radial-gradient(ellipse at 110% 10%, rgba(77,208,225,.2), transparent 50%);
    }

    /* Subtle network grid / nodes */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.18;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(124,77,255,.6) 2px, transparent 2px),
        radial-gradient(circle at 30% 70%, rgba(77,208,225,.6) 2px, transparent 2px),
        radial-gradient(circle at 60% 30%, rgba(124,77,255,.6) 2px, transparent 2px),
        radial-gradient(circle at 80% 80%, rgba(77,208,225,.6) 2px, transparent 2px),
        linear-gradient(transparent 49.5%, rgba(255,255,255,.07) 50%, transparent 50.5%),
        linear-gradient(90deg, transparent 49.5%, rgba(255,255,255,.07) 50%, transparent 50.5%);
      background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 60px 60px, 60px 60px;
      mix-blend-mode: screen;
    }

    .wrap{max-width: 980px; margin: 32px auto; padding: 0 16px 80px}

    header{
      display:flex; align-items:center; gap:16px; margin:16px 0 24px;
    }
    .logo{
      width:56px; height:56px; border-radius:14px; background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.3), transparent 40%),
        linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid; place-items:center; color:#001016; font-weight:900; letter-spacing:.5px;
      outline: 2px solid rgba(255,255,255,.2);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    h1{margin:0; font-size: clamp(1.4rem, 1.1rem + 2vw, 2.2rem)}
    p.lead{margin:.25rem 0 0; color:var(--muted)}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px; padding: 18px; margin: 16px 0;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }

    label{display:block; font-weight:600; margin: 4px 0 8px}
    input[type="text"], textarea{
      width:100%; color:var(--ink); background: #0f1530;
      border:1px solid rgba(255,255,255,.18); border-radius:12px;
      padding:12px 14px; font:inherit; resize:vertical; min-height:46px;
      outline:none; transition:.2s border-color, .2s box-shadow;
    }
    textarea{min-height:110px}
    input[type="text"]:focus, textarea:focus{border-color: var(--accent); box-shadow: 0 0 0 3px rgba(77,208,225,.25)}
    .field-error{border-color: var(--danger) !important; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important}

    .q{display:grid; gap:10px}
    .q h3{margin:.2rem 0; font-size:1.05rem}
    .points{color:var(--muted); font-weight:600; font-size:.95rem}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 780px){ .row{grid-template-columns: 1fr} }

    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top: 24px}
    button{
      appearance:none; border:none; cursor:pointer; border-radius:12px; padding:12px 16px; font-weight:700;
      color:#05101a; background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 20px rgba(0,0,0,.25); transition: transform .06s ease-in-out, filter .2s;
    }
    button:hover{filter:brightness(1.06)}
    button:active{transform: translateY(1px)}
    .ghost{background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.25)}

    .save-indicator{font-size:.9rem; color:var(--muted)}
    
    .review-message{
      font-size:.9rem; color:var(--muted);
      align-self: center; /* Align it vertically with the buttons */
      margin-right: auto; /* Push it to the left */
      padding: 0 10px;
    }

    .validation-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--danger);
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 350px;
      font-weight: 600;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">NET</div>
      <div>
        <h1>Fiche √©l√®ve ‚Äì R√©seaux informatiques</h1>
        <p class="lead">Compl√®te les r√©ponses apr√®s avoir regard√© attentive la vid√©o associ√©e.</p>
        <p class="lead">Puis utilise le bouton ¬´ T√©l√©charger la fiche ¬ª pour g√©n√©rer un PDF, qui sera d√©pos√© dans Pearltrees.</p>
        <p id="user-info" class="text-sm mt-2 text-muted"></p>
      </div>
    </header>

    <section class="card row" id="identite">
      <div>
        <label for="nom">Nom</label>
        <input id="nom" name="nom" type="text" placeholder="Pr√©nom NOM" autocomplete="name" />
      </div>
      <div>
        <label for="classe">Classe</label>
        <input id="classe" name="classe" type="text" placeholder="ex. 5e B" />
      </div>
    </section>

    <section class="card q" id="q1">
      <h3>üñäÔ∏è 1) Liste les nouveaux mots que tu viens d'apprendre dans la vid√©o. <span class="points">(2 points)</span></h3>
      <textarea id="r1" placeholder="√âcris la liste de tes mots nouveaux‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q2">
      <h3>üñäÔ∏è 2) C'est quoi un r√©seau ? Explique avec tes mots (1‚Äì2 phrases). <span class="points">(3 points)</span></h3>
      <textarea id="r2" placeholder="Ta d√©finition personnelle du r√©seau‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q3">
      <h3>üñäÔ∏è 3) Qui est le ¬´ chef d'orchestre ¬ª du r√©seau ? <span class="points">(2 points)</span></h3>
      <textarea id="r3" placeholder="Nomme l'appareil et explique son r√¥le en 1 phrase‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q4">
      <h3>üñäÔ∏è 4) Pourquoi a‚Äët‚Äëon besoin d'une adresse IP ? <span class="points">(3 points)</span></h3>
      <textarea id="r4" placeholder="Explique l'utilit√© avec un petit exemple‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q5">
      <h3>üñäÔ∏è 5) Quel appareil permet de relier plusieurs ordinateurs ensemble ? <span class="points">(2 points)</span></h3>
      <textarea id="r5" placeholder="Nom de l'appareil et image mentale (place du village)‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q6">
      <h3>üñäÔ∏è 6) Comment circulent les messages sur Internet ? <span class="points">(3 points)</span></h3>
      <textarea id="r6" placeholder="D√©cris le trajet simplement‚Ä¶"></textarea>
    </section>

    <section class="card q" id="q7">
      <h3>üñäÔ∏è 7) Diff√©rence entre une adresse IP publique et une adresse IP priv√©e ? <span class="points">(5 points)</span></h3>
      <textarea id="r7" placeholder="Explique la diff√©rence + m√©taphore (immeuble/appartements)‚Ä¶"></textarea>
    </section>

    <div class="actions">
      <p class="review-message">‚ö†Ô∏è Pense √† te relire avant de t√©l√©charger le fichier. Les mots soulign√©s en rouge indiquent une faute d'orthographe.</p>
      <span class="save-indicator" id="saveState">Connexion...</span>
      <button type="button" id="printBtn" title="T√©l√©charger la fiche">üì• T√©l√©charger la fiche</button>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global variables from the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const fields = ["nom", "classe", "r1", "r2", "r3", "r4", "r5", "r6", "r7"];
    const saveState = document.getElementById('saveState');
    const printBtn = document.getElementById('printBtn');
    const userInfoEl = document.getElementById('user-info');

    let db, auth, userId;
    let saveTimeout;
    const DEBOUNCE_TIME = 1000; // 1 second debounce
    
    // Map of question IDs to their full text
    const questionsMap = {
        'r1': "1) Liste les nouveaux mots que tu viens d'apprendre dans la vid√©o. (2 points)",
        'r2': "2) C'est quoi un r√©seau ? Explique avec tes mots (1‚Äì2 phrases). (3 points)",
        'r3': "3) Qui est le ¬´ chef d'orchestre ¬ª du r√©seau ? (2 points)",
        'r4': "4) Pourquoi a‚Äët‚Äëon besoin d'une adresse IP ? (3 points)",
        'r5': "5) Quel appareil permet de relier plusieurs ordinateurs ensemble ? (2 points)",
        'r6': "6) Comment circulent les messages sur Internet ? (3 points)",
        'r7': "7) Diff√©rence entre une adresse IP publique et une adresse IP priv√©e ? (5 points)"
    };


    // Save data to Firestore with a debounce to prevent excessive writes
    async function save() {
      if (!userId) {
        saveState.textContent = "Sauvegarde en attente...";
        return;
      }
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        console.log("Saving data...");
        saveState.textContent = "Sauvegarde...";
        const data = {};
        fields.forEach(id => {
          const el = document.getElementById(id);
          if (el) data[id] = el.value;
        });
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/fiches-eleve`, 'fiche-reseaux');
        await setDoc(docRef, data, { merge: true });
        saveState.textContent = "Sauvegard√© ‚úî";
      }, DEBOUNCE_TIME);
    }
    
    // Load data from Firestore
    function load() {
      if (!userId) {
        saveState.textContent = "ID utilisateur non disponible.";
        return;
      }
      saveState.textContent = "Chargement...";
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/fiches-eleve`, 'fiche-reseaux');
      
      onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          fields.forEach(id => {
            const el = document.getElementById(id);
            if (el && data[id] !== undefined) {
              el.value = data[id];
            }
          });
          saveState.textContent = "Charg√©";
        } else {
          saveState.textContent = "Nouvelle fiche";
        }
      }, (error) => {
        console.error("Error fetching document:", error);
        saveState.textContent = "Erreur de connexion";
      });
    }

    // Check if all fields are filled
    function validateForm() {
      const emptyFields = [];
      
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el && (!el.value || el.value.trim() === '')) {
          emptyFields.push(getFieldName(id));
          el.classList.add('field-error');
        } else if (el) {
          el.classList.remove('field-error');
        }
      });
      
      return emptyFields;
    }
    
    // Get friendly field names
    function getFieldName(id) {
      const names = {
        'nom': 'Nom',
        'classe': 'Classe',
        'r1': 'Question 1 (nouveaux mots)',
        'r2': 'Question 2 (d√©finition r√©seau)',
        'r3': 'Question 3 (chef d\'orchestre)',
        'r4': 'Question 4 (adresse IP)',
        'r5': 'Question 5 (appareil de liaison)',
        'r6': 'Question 6 (circulation messages)',
        'r7': 'Question 7 (IP publique/priv√©e)'
      };
      return names[id] || id;
    }
    
    // Show validation alert
    function showValidationAlert(emptyFields) {
      const existingAlert = document.querySelector('.validation-alert');
      if (existingAlert) existingAlert.remove();
      
      const alert = document.createElement('div');
      alert.className = 'validation-alert';
      alert.innerHTML = `
        <strong>‚ö†Ô∏è Formulaire incomplet</strong><br>
        Veuillez remplir tous les champs :<br>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
          ${emptyFields.slice(0, 3).map(field => `<li>${field}</li>`).join('')}
          ${emptyFields.length > 3 ? `<li>... et ${emptyFields.length - 3} autre(s)</li>` : ''}
        </ul>
      `;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 6000);
    }
    
    // Generate PDF document with selectable text
    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      
      const emptyFields = validateForm();
      if (emptyFields.length > 0) {
        console.log("Validation failed. Fields to fill:", emptyFields);
        showValidationAlert(emptyFields);
        return;
      }
      console.log("Form is valid, generating PDF...");

      try {
        const doc = new jsPDF();
        let y = 20; // Initial vertical position
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        const contentWidth = doc.internal.pageSize.getWidth() - 2 * margin;

        // Add Title
        doc.setFontSize(24);
        doc.text("Fiche √©l√®ve ‚Äì R√©seaux informatiques", margin, y);
        y += 15;

        // Add student info
        const nom = document.getElementById('nom').value;
        const classe = document.getElementById('classe').value;
        doc.setFontSize(12);
        doc.text(`Nom: ${nom}`, margin, y);
        doc.text(`Classe: ${classe}`, margin + contentWidth / 2, y);
        y += 15;

        // Add each question and answer
        for (const id of fields) {
          if (id === 'nom' || id === 'classe') continue;
          
          const questionText = questionsMap[id] || `Question ${id}`;
          const answerText = document.getElementById(id).value;
          
          // Add question title
          doc.setFontSize(14);
          const questionLines = doc.splitTextToSize(questionText, contentWidth);
          if (y + (questionLines.length * 10) > pageHeight - margin) {
              doc.addPage();
              y = margin;
          }
          doc.text(questionLines, margin, y);
          y += (questionLines.length * 7);

          // Add answer content (handle line breaks)
          doc.setFontSize(12);
          const answerLines = doc.splitTextToSize(answerText, contentWidth);
          for (const line of answerLines) {
              if (y > pageHeight - margin) {
                  doc.addPage();
                  y = margin;
              }
              doc.text(line, margin, y);
              y += 7;
          }

          y += 10; // Spacing after each answer
        }

        doc.save(`${nom}-${classe}-fiche-reseaux.pdf`);
        console.log("PDF generated successfully.");
      } catch (error) {
          console.error("Error during PDF generation:", error);
          alert("Une erreur est survenue lors de la g√©n√©ration du PDF. Veuillez v√©rifier les champs et r√©essayer.");
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("Initializing Firebase...");
      // Firebase initialization
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      // Authenticate user
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("User authenticated:", user.uid);
          userId = user.uid;
          userInfoEl.textContent = `Connect√©. ID utilisateur : ${userId}`;
          load();
        } else {
          try {
            console.log("User not authenticated. Signing in anonymously...");
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Firebase auth error:", error);
            userInfoEl.textContent = "Erreur de connexion";
          }
        }
      });
      
      // Bind input events for auto-save
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', save);
          el.addEventListener('blur', () => {
            if (!el.value.trim()) {
              el.classList.add('field-error');
            } else {
              el.classList.remove('field-error');
            }
          });
        }
      });
      
      // Print button event
      printBtn.addEventListener('click', (e) => {
        e.preventDefault();
        generatePDF();
      });
    });

